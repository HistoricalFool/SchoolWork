---
title: Problem Set 6
author: Tate Mason
format: pdf
---

# Hansen 17.2

# Question 1

```{r}
library(Matrix)
library(dplyr)
library(tidyr)
library(magrittr)

df <- read.csv('metrics.csv')
```

## Part A

```{r}
## Creating Variables
y <- df$learn
D <- as.numeric(df$first.displaced <= df$year)
id <- df$id
year <- df$year

indiv <- as.factor(id)
n_indiv <- length(unique(id))
N <- length(y)

time <- as.factor(year)
n_periods <- length(unique(year))

X_time <- sparse.model.matrix(~ time - 1)
X_indiv <- sparse.model.matrix(~ indiv - 1)

X_treat <- as.matrix(D)

X <- cbind(X_time, X_treat)
colnames(X)[ncol(X)] <- "treatment"

demean <- function(variable, id) {
  df_temp <- data.frame(var = variable, id = id)
  means <- aggregate(var ~ id, data = df_temp, mean)
  result <- variable - means$var[match(id, means$id)]
  return(result)
}

# Demean the outcome
y_demean <- demean(y, id)

# Demean each predictor
X_demean1 <- matrix(0, nrow=nrow(X), ncol=ncol(X))
colnames(X_demean1) <- colnames(X)

for(j in 1:ncol(X)) {
  X_demean1[,j] <- demean(X[,j], id)
}

X_demean <- X_demean1 + matrix(rnorm(nrow(X_demean1)*ncol(X_demean1), 0, 1e-10), nrow=nrow(X_demean1), ncol=ncol(X_demean1))

XtX <- crossprod(X_demean)
XtY <- crossprod(X_demean, y_demean)
beta_hat <- MASS::ginv(XtX) %*% XtY

alpha_hat <- beta_hat[length(beta_hat)]

## Standard Errors
e_hat <- y_demean - as.vector(X_demean%*%beta_hat)
sigma_sq <- sum(e_hat^2)/(N-n_periods - 1)
var_beta <- sigma_sq*MASS::ginv(crossprod(X_demean))
se_alpha <- sqrt(var_beta[nrow(var_beta), ncol(var_beta)])
```

```{r}
cat("Part A: Report of Estimates\n")
cat("Estimated alpha:", alpha_hat, "\n")
cat("Standard Error of alpha:", se_alpha, "\n")
```

## Part B

## Part C

## Part D

# Question 2

# Question 3
