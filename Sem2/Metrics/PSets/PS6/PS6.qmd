---
title: Problem Set 6
author: Tate Mason
format: pdf
---

# Hansen 17.2

# Question 1

```{r}
library(Matrix)
library(dplyr)
library(tidyr)
library(magrittr)

df <- read.csv('metrics.csv')
```

## Part A

```{r}
# Creating Variables
id <- df$id
year <- df$year

n <- length(unique(id))
t <- length(unique(year))
nt <- n*t

df %<>% mutate(D=1*(first.displaced <= year & first.displaced !=0), yearf = factor(year))

Y <- Matrix(df$learn)
X <- model.matrix(~ yearf + D-1, data = df)
X <- Matrix(X)

I <- diag(nt)
D <- bdiag(replicate(n,Matrix(rep(1,t)),simplify=FALSE))
M <- I - D%*%solve(t(D)%*%D)%*%t(D)
alpha_hat <- solve(t(X)%*%M%*%X)%*%t(X)%*%M%*%Y
e_hat <- Y - X%*%alpha_hat
var_error = as.numeric(t(e_hat) %*% e_hat) / (nt - ncol(X))
var_alpha = var_error * solve(t(X) %*% M %*% X)
se_alpha = sqrt(diag(var_alpha))
```

```{r}
cat("Part A: Report of Estimates\n")
alpha_hat
se_alpha
```

## Part B

```{r}
id <- df$id
year <- df$year

n <- length(unique(id))
t <- length(unique(year))
nt <- n*t

df %<>% mutate(D=1*(first.displaced <= year & first.displaced !=0), yearf = factor(year))
disp_years <- sort(unique(df$first.displaced[df$first.displaced > 0]))
disp_results <- list()

for (g in disp_years) {
  df %<>% mutate(D_g=1*(first.displaced == g & year>=g))

  Y <- Matrix(df$learn)

  X<- model.matrix(~ yearf + D_g-1, data = df)
  X <- Matrix(X)

  I <- diag(nt)
  D <- bdiag(replicate(n,Matrix(rep(1,t)),simplify=FALSE))
  M <- I - D%*%solve(t(D)%*%D)%*%t(D)

  alpha_hat <- solve(t(X)%*%M%*%X)%*%t(X)%*%M%*%Y
  e_hat <- Y - X%*%alpha_hat
  var_error = as.numeric(t(e_hat) %*% e_hat) / (nt - ncol(X))
  var_alpha = var_error * solve(t(X) %*% M %*% X)
  se_alpha = sqrt(diag(var_alpha))

  disp_results[[as.character(g)]] <- list(
    disp_year = g,
    alpha_hat = alpha_hat,
    se_alpha = se_alpha
  )

  df$D_g <- NULL
}

extract_treatment_effect <- function(result) {
  n_years <- length(unique(df$year))
  treatment_index <- n_years + 1

  coef <- results$alpha_hat[treatment_index]
  se <- results$se_alpha[treatment_index]

  return(data.frame(
    disp_year = result$disp_year,
    estimate = coef,
    se = se,
    t_stat = coef / se,
    p_value = 2 * pt(abs(coef / se), df = nt-ncol(X), lower.tail=FALSE)
  ))
}

treatment_effects <- do.call(rbind, lapply(disp_results, extract_treatment_effect))

print(treatment_effects)
```

## Part C

## Part D

# Question 2
