---
title: "Problem Set 1: PSID - Labor Outcomes"
author: Tate Mason
format: pdf
---

## Part 1: Overall Trends:

```{r, output=FALSE}
library(AER)
library(haven)
library(tidyverse)
library(psych)
library(patchwork)
library(broom)
```

```{r}
df <- read_dta("~/SchoolWork/Y2S1/Macro/Data/PSID/PSID.dta")
```

```{r, echo=FALSE}
psid_99_clean <- df %>%
  transmute(
    year = 1999,
    age = ER13010,
    sex = ER13011,
    lfp = ER13601,
    wage = ER13224,
    hr_worked = ER13363,
    cpi_ratio = 0.644,
    educ_HS = ER15937,
    educ_coll = ER15953,
    ind = ER13216,
    wealth = S417,
    weight = ER16518,
    inc = ER13218
  )
psid_01_clean <- df %>%
  transmute(
    year = 2001,
    age = ER17013,
    sex = ER17014,
    lfp = ER17657,
    wage = ER17235,
    hr_worked = ER17393,
    cpi_ratio = 0.685,
    educ_HS = ER19998,
    educ_coll = ER20014,
    ind = ER17227,
    wealth = S517,
    weight = ER20394,
    inc = ER17229
  )
psid_03_clean <- df %>%
  transmute(
    year = 2003,
    age = ER21017,
    sex = ER21018,
    lfp = ER21339,
    wage = ER21159,
    hr_worked = ER21356,
    cpi_ratio = 0.711,
    educ_HS = ER23435,
    educ_coll = ER23451,
    ind = ER21146,
    wealth = S617,
    weight = ER24179,
    inc = ER21153
  )
psid_05_clean <- df %>%
  transmute(
    year = 2005,
    age = ER25017,
    sex = ER25018,
    lfp = ER25328,
    wage = ER25148,
    hr_worked = ER25345,
    cpi_ratio = 0.755,
    educ_HS = ER27402,
    educ_coll = ER27418,
    ind = ER25128,
    wealth = S717,
    weight = ER28078,
    inc = ER25142
  )
psid_07_clean <- df %>%
  transmute(
    year = 2007,
    age = ER36017,
    sex = ER36018,
    lfp = ER36333,
    wage = ER36153,
    hr_worked = ER36350,
    cpi_ratio = 0.802,
    educ_HS = ER40574,
    educ_coll = ER40590,
    ind = ER36133,
    wealth = S817,
    weight = ER41069,
    inc = ER36147
  )
psid_09_clean <- df %>%
  transmute(
    year = 2009,
    age = ER42017,
    sex = ER42018,
    lfp = ER42360,
    wage = ER42188,
    hr_worked = ER42148,
    cpi_ratio = 0.829,
    educ_HS = ER46552,
    educ_coll = ER46568,
    ind = ER42168,
    wealth = ER46970,
    weight = ER47012,
    inc = ER42182
  )
psid_11_clean <- df %>%
  transmute(
    year = 2011,
    age = ER47317,
    sex = ER47318,
    lfp = ER47673,
    wage = ER47501,
    hr_worked = ER47456,
    cpi_ratio = 0.867,
    educ_HS = ER51913,
    educ_coll = ER51929,
    ind = ER47480,
    wealth = ER52394,
    weight = ER52436,
    inc = ER47495
  )
psid_13_clean <- df %>%
  transmute(
    year = 2013,
    age = ER53017,
    sex = ER53018,
    lfp = ER53636,
    wage = ER53201,
    hr_worked = ER53156,
    cpi_ratio = 0.901,
    educ_HS = ER57669,
    educ_coll = ER57685,
    ind = ER53180,
    wealth = ER58211,
    weight = ER58257,
    inc = ER53195
  )
psid_15_clean <- df %>%
  transmute(
    year = 2015,
    age = ER60017,
    sex = ER60018,
    lfp = ER60388,
    wage = ER60216,
    hr_worked = ER60171,
    cpi_ratio = 0.916,
    educ_HS = ER64821,
    educ_coll = ER64837,
    ind = ER60195,
    wealth = ER65408,
    weight = ER65492,
    inc = ER60210
  )
psid_17_clean <- df %>%
  transmute(
    year = 2017,
    age = ER66017,
    sex = ER66018,  
    lfp = ER66666,
    wage = ER66492,
    hr_worked = ER66172,
    cpi_ratio = 0.947,
    educ_HS = ER70755,
    educ_coll = ER70909,
    ind = ER66196,
    wealth = ER71485,
    weight = ER71570,
    inc = ER66211
  )
psid_clean <- bind_rows(
  psid_99_clean,
  psid_01_clean,
  psid_03_clean,
  psid_05_clean,
  psid_07_clean,
  psid_09_clean,
  psid_11_clean,
  psid_13_clean,
  psid_15_clean,
  psid_17_clean
) 

psid_clean <- psid_clean %>%
  group_by(year) %>%
  filter(
    wage <= 997,
    inc <= 9999997,
    hr_worked <= 112
  ) %>%
  mutate(
    educ_group = case_when(
      educ_HS == 3 ~ "HS Dropout",
      educ_HS == 1 & educ_coll == 2 ~ "HS Graduate",
      educ_coll >= 2 & educ_coll <= 7 ~ "College Plus",
      TRUE ~ NA_character_
    ),
    ind_group = case_when(
      ind %in% c(range(17:28), range(47:57), range(67:77), range(107:398)) ~ "Blue Collar",
      ind %in% c(range(407:479), range(507:698), range(707:718), range(727:759), 
        range(769:798), range(807:809), range(828:897), range(907:937)) ~ "White Collar",
      TRUE ~ NA_character_
    ),
    wealth_group = case_when(
      wealth > -99999999 & wealth < 25000 ~ "Low Wealth",
      wealth >= 25000 & wealth < 100000 ~ "Medium Wealth",
      wealth >= 100000 & wealth <= 99999998 ~ "High Wealth",
      TRUE ~ NA_character_
    ),
    wage_real = wage * cpi_ratio,
    inc_real = inc * cpi_ratio,
    log_wage = if_else(wage > 0, log(wage_real), NA_real_),
    log_hr_worked = if_else(hr_worked > 0, log(hr_worked), NA_real_),
    lfp = case_when(
      lfp == 0 ~ 1,
      lfp >= 1 & lfp <= 52 ~ 0,
      TRUE ~ NA_real_
    )
  )

psid_m <- psid_clean %>%
  filter(
    age >= 25 & age <= 60,
    sex == 1
  )
```

# Age profiles

```{r}
wm <- function(x,w) weighted.mean(x, w, na.rm=TRUE)

age_profile_fe <- function(data, y, base_age = 25, w_col = weight) {
  yq <- rlang::enquo(y)
  wq <- rlang::enquo(w_col)

  d <- data %>%
    filter(!is.na(!!yq), !is.na(!!wq)) %>%
    mutate(
      age  = as.integer(age),
      year = as.integer(year)
    )

  if (nrow(d) == 0) return(tibble(age = integer(), y_m = numeric()))

  # build formula: response ~ factor(age) + factor(year)
  resp <- rlang::as_name(yq)
  fml  <- stats::as.formula(paste(resp, "~ factor(age) + factor(year)"))

  # evaluate weights as a numeric vector
  wv <- as.numeric(rlang::eval_tidy(wq, d))

  reg <- stats::lm(fml, data = d, weights = wv)

  af <- broom::tidy(reg) %>%
    dplyr::filter(grepl("^factor\\(age\\)", term)) %>%
    dplyr::mutate(age = as.integer(gsub("factor\\(age\\)", "", term))) %>%
    tidyr::complete(age = base_age:60, fill = list(estimate = 0)) %>%
    dplyr::arrange(age) %>%
    dplyr::transmute(age, y_m = estimate)

  mu <- mean(d[[resp]], na.rm = TRUE)
  dplyr::mutate(af, y_m = y_m + mu)
}

var_prof_year_net <- function(data, y, w_col = weight) {
  yq <- rlang::enquo(y)
  wq <- rlang::enquo(w_col)

  d <- data %>%
    filter(!is.na(!!yq), !!yq > 0, !is.na(!!wq)) %>%
    mutate(
      age  = as.integer(age),
      year = as.integer(year),
      ly   = log(!!yq),
      w    = as.numeric(!!wq)   # <- carry weights as a column
    )

  if (nrow(d) == 0) return(tibble(age = integer(), v = numeric()))

  # Remove year effects with weighted regression
  reg <- stats::lm(ly ~ factor(year), data = d, weights = d$w)
  d$res <- stats::resid(reg)

  # Weighted variance within each age using that age group's weights
  d %>%
    group_by(age) %>%
    summarise(
      v = {
        wg <- w
        rg <- res
        mu <- weighted.mean(rg, wg, na.rm = TRUE)
        sum(wg * (rg - mu)^2, na.rm = TRUE) / sum(wg, na.rm = TRUE)
      },
      .groups = "drop"
    )
}
  
lfp_age_fe <- age_profile_fe(psid_m, lfp)
wage_age_fe <- age_profile_fe(psid_m, wage_real)
hr_age_fe <- age_profile_fe(psid_m, hr_worked)
inc_age_fe <- age_profile_fe(psid_m, inc_real)
var_wage_age <- var_prof_year_net(psid_m, wage_real)
var_hr_age <- var_prof_year_net(psid_m, hr_worked)

ggplot(lfp_age_fe, aes(age, y_m)) +
  geom_line(size = 1.2) +
  labs(
    title = "Labor Force Participation Rate",
    x = "Age",
    y = "LFP Rate"
  ) + 
  theme_minimal()
ggsave("lfp_age_fe.pdf", width = 6, height = 4)

ggplot(wage_age_fe, aes(age, y_m)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Wage",
    x = "Age",
    y = "Real Wage (2017 $)"
  ) + 
  theme_minimal()
ggsave("wage_age_fe.pdf", width = 6, height = 4)

ggplot(hr_age_fe, aes(age, y_m)) +
  geom_line(size = 1.2) +
  labs(
    title = "Hours Worked per Week",
    x = "Age",
    y = "Hours Worked"
  ) +
  theme_minimal()
ggsave("hr_age_fe.pdf", width = 6, height = 4)

ggplot(inc_age_fe, aes(age, y_m)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Annual Income",
    x = "Age",
    y = "Real Income (2017 $)"
  ) +
  theme_minimal()
ggsave("inc_age_fe.pdf", width = 6, height = 4)

ggplot(var_wage_age, aes(age, v)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Real Wage (Net of Year Effects)",
    x = "Age",
    y = "Variance"
  ) +
  theme_minimal()
ggsave("var_wage_age.pdf", width = 6, height = 4)

ggplot(var_hr_age, aes(age, v)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Hours Worked (Net of Year Effects)",
    x = "Age",
    y = "Variance"
  ) +
  theme_minimal()
ggsave("var_hr_age.pdf", width = 6, height = 4)
```

## Education groups
```{r}
wage_age_fe_educ <- psid_m %>%
  filter(!is.na(educ_group)) %>%
  group_by(educ_group) %>%
  group_modify(~ age_profile_fe(.x, wage_real)) %>%
  ungroup()

hour_age_fe_educ <- psid_m %>%
  filter(!is.na(educ_group)) %>%
  group_by(educ_group) %>%
  group_modify(~ age_profile_fe(.x, hr_worked)) %>%
  ungroup()

lfp_age_fe_educ <- psid_m %>%
  filter(!is.na(educ_group)) %>%
  group_by(educ_group) %>%
  group_modify(~ age_profile_fe(.x, lfp)) %>%
  ungroup()

inc_age_fe_educ <- psid_m %>%
  filter(!is.na(educ_group)) %>%
  group_by(educ_group) %>%
  group_modify(~ age_profile_fe(.x, inc_real)) %>%
  ungroup()

var_wage_age_educ <- psid_m %>%
  filter(!is.na(educ_group)) %>%
  group_by(educ_group) %>%
  group_modify(~ var_prof_year_net(.x, wage_real)) %>%
  ungroup()

var_hr_age_educ <- psid_m %>%
  filter(!is.na(educ_group)) %>%
  group_by(educ_group) %>%
  group_modify(~ var_prof_year_net(.x, hr_worked)) %>%
  ungroup()
```

```{r}
ggplot(lfp_age_fe_educ, aes(age, y_m, color = educ_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Labor Force Participation Rate by Education",
    x = "Age",
    y = "LFP Rate",
    color = "Education"
  ) +
  theme_minimal()
ggsave("lfp_age_fe_educ.pdf", width = 6, height = 4)

ggplot(inc_age_fe_educ, aes(age, y_m, color = educ_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Annual Income by Education",
    x = "Age",
    y = "Real Income",
    color = "Education"
  ) +
  theme_minimal()
ggsave("inc_age_fe_educ.pdf", width = 6, height = 4)

ggplot(wage_age_fe_educ, aes(age, y_m, color = educ_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Wage by Education",
    x = "Age",
    y = "Real Wage",
    color = "Education"
  ) +
  theme_minimal()
ggsave("wage_age_fe_educ.pdf", width = 6, height = 4)

ggplot(hour_age_fe_educ, aes(age, y_m, color = educ_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Hours Worked per Week by Education",
    x = "Age",
    y = "Hours Worked",
    color = "Education"
  ) +
  theme_minimal()
ggsave("hr_age_fe_educ.pdf", width = 6, height = 4)

ggplot(var_wage_age_educ, aes(age, v, color = educ_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Real Wage (Net of Year Effects) by Education",
    x = "Age",
    y = "Variance",
    color = "Education"
  ) +
  theme_minimal()
ggsave("var_wage_age_educ.pdf", width = 6, height = 4)

ggplot(var_hr_age_educ, aes(age, v, color = educ_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Hours Worked (Net of Year Effects) by Education",
    x = "Age",
    y = "Variance",
    color = "Education"
  ) +
  theme_minimal()
ggsave("var_hr_age_educ.pdf", width = 6, height = 4)
```

## Industry groups
```{r}
wage_age_fe_ind <- psid_m %>%
  filter(!is.na(ind_group)) %>%
  group_by(ind_group) %>%
  group_modify(~ age_profile_fe(.x, wage_real)) %>%
  ungroup()

hour_age_fe_ind <- psid_m %>%
  filter(!is.na(ind_group)) %>%
  group_by(ind_group) %>%
  group_modify(~ age_profile_fe(.x, hr_worked)) %>%
  ungroup()

inc_age_fe_ind <- psid_m %>%
  filter(!is.na(ind_group)) %>%
  group_by(ind_group) %>%
  group_modify(~ age_profile_fe(.x, inc_real)) %>%
  ungroup()

lfp_age_fe_ind <- psid_m %>%
  filter(!is.na(ind_group)) %>%
  group_by(ind_group) %>%
  group_modify(~ age_profile_fe(.x, lfp)) %>%
  ungroup()

var_wage_age_ind <- psid_m %>%
  filter(!is.na(ind_group)) %>%
  group_by(ind_group) %>%
  group_modify(~ var_prof_year_net(.x, wage_real)) %>%
  ungroup()

var_hr_age_ind <- psid_m %>%
  filter(!is.na(ind_group)) %>%
  group_by(ind_group) %>%
  group_modify(~ var_prof_year_net(.x, hr_worked)) %>%
  ungroup()

ggplot(lfp_age_fe_ind, aes(age, y_m, color = ind_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Labor Force Participation Rate by Industry",
    x = "Age",
    y = "LFP Rate",
    color = "Industry"
  ) +
  theme_minimal()
ggsave("lfp_age_fe_ind.pdf", width = 6, height = 4)

ggplot(wage_age_fe_ind, aes(age, y_m, color = ind_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Wage by Industry",
    x = "Age",
    y = "Real Wage",
    color = "Industry"
  ) +
  theme_minimal()
ggsave("wage_age_fe_ind.pdf", width = 6, height = 4)

ggplot(hour_age_fe_ind, aes(age, y_m, color = ind_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Hours Worked per Week by Industry",
    x = "Age",
    y = "Hours Worked",
    color = "Industry"
  ) +
  theme_minimal()
ggsave("hr_age_fe_ind.pdf", width = 6, height = 4)

ggplot(inc_age_fe_ind, aes(age, y_m, color = ind_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Annual Income by Industry",
    x = "Age",
    y = "Real Income",
    color = "Industry"
  ) +
  theme_minimal()
ggsave("inc_age_fe_ind.pdf", width = 6, height = 4)

ggplot(var_wage_age_ind, aes(age, v, color = ind_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Real Wage (Net of Year Effects) by Industry",
    x = "Age",
    y = "Variance",
    color = "Industry"
  ) +
  theme_minimal()
ggsave("var_wage_age_ind.pdf", width = 6, height = 4)

ggplot(var_hr_age_ind, aes(age, v, color = ind_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Hours Worked (Net of Year Effects) by Industry",
    x = "Age",
    y = "Variance",
    color = "Industry"
  ) +
  theme_minimal()
ggsave("var_hr_age_ind.pdf", width = 6, height = 4)
```

## Wealth groups
```{r}
wage_age_fe_wealth <- psid_m %>%
  filter(!is.na(wealth_group)) %>%
  group_by(wealth_group) %>%
  group_modify(~ age_profile_fe(.x, wage_real)) %>%
  ungroup()

hour_age_fe_wealth <- psid_m %>%
  filter(!is.na(wealth_group)) %>%
  group_by(wealth_group) %>%
  group_modify(~ age_profile_fe(.x, hr_worked)) %>%
  ungroup()

inc_age_fe_wealth <- psid_m %>%
  filter(!is.na(wealth_group)) %>%
  group_by(wealth_group) %>%
  group_modify(~ age_profile_fe(.x, inc_real)) %>%
  ungroup()

lfp_age_fe_wealth <- psid_m %>%
  filter(!is.na(wealth_group)) %>%
  group_by(wealth_group) %>%
  group_modify(~ age_profile_fe(.x, lfp)) %>%
  ungroup()

var_wage_age_wealth <- psid_m %>%
  filter(!is.na(wealth_group)) %>%
  group_by(wealth_group) %>%
  group_modify(~ var_prof_year_net(.x, wage_real)) %>%
  ungroup()

var_hr_age_wealth <- psid_m %>%
  filter(!is.na(wealth_group)) %>%
  group_by(wealth_group) %>%
  group_modify(~ var_prof_year_net(.x, hr_worked)) %>%
  ungroup()

ggplot(lfp_age_fe_wealth, aes(age, y_m, color = wealth_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Labor Force Participation Rate by Wealth",
    x = "Age",
    y = "LFP Rate",
    color = "Wealth"
  ) +
  theme_minimal()
ggsave("lfp_age_fe_wealth.pdf", width = 6, height = 4)

ggplot(wage_age_fe_wealth, aes(age, y_m, color = wealth_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Wage by Wealth",
    x = "Age",
    y = "Real Wage",
    color = "Wealth"
  ) +
  theme_minimal()
ggsave("wage_age_fe_wealth.pdf", width = 6, height = 4)

ggplot(hour_age_fe_wealth, aes(age, y_m, color = wealth_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Hours Worked per Week by Wealth",
    x = "Age",
    y = "Hours Worked",
    color = "Wealth"
  ) +
  theme_minimal()
ggsave("hr_age_fe_wealth.pdf", width = 6, height = 4)

ggplot(inc_age_fe_wealth, aes(age, y_m, color = wealth_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Real Annual Income by Wealth",
    x = "Age",
    y = "Real Income",
    color = "Wealth"
  ) +
  theme_minimal()
ggsave("inc_age_fe_wealth.pdf", width = 6, height = 4)

ggplot(var_wage_age_wealth, aes(age, v, color = wealth_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Real Wage (Net of Year Effects) by Wealth",
    x = "Age",
    y = "Variance",
    color = "Wealth"
  ) +
  theme_minimal()
ggsave("var_wage_age_wealth.pdf", width = 6, height = 4)

ggplot(var_hr_age_wealth, aes(age, v, color = wealth_group)) +
  geom_line(size = 1.2) +
  labs(
    title = "Variance of Log Hours Worked (Net of Year Effects) by Wealth",
    x = "Age",
    y = "Variance",
    color = "Wealth"
  ) +
  theme_minimal()
ggsave("var_hr_age_wealth.pdf", width = 6, height = 4)
```




